#!/bin/bash
set -eu

DOTPATH="${HOME}/dotfiles"

. ${DOTPATH}/etc/logger.sh
. ${DOTPATH}/etc/neovim_setting.sh

cd ${DOTPATH}

# main関数
# 全ての設定ファイルに対してシンボリックリンクを作成する
function main () {

  local DOTLIST=(".vimrc" ".bash_profile" ".zprofile" ".zshrc")
  DOTLIST+=(".bashrc")
  DOTLIST+=(".tmux.conf")
  DOTLIST+=(".Brewfile")

  for var in ${DOTLIST[@]}
  do
    create_ln ${var}
  done

  # Neovim -----------------------------------
  neovim_setting

  # Claude Skills ----------------------------
  claude_skills_setting

  # Claude Context ---------------------------
  claude_context_setting

  # Claude CLAUDE.md -------------------------
  claude_md_setting
}

# シンボリックリンクを貼る関数
# 同じファイルが存在する場合、上書きする
# $1: 対象ファイル
function create_ln () {
  local FILE=$1

  ln -vsf ${DOTPATH}/${FILE} ${HOME}/${FILE}
  return 0
}

# ホームディレクトリ直下に対象のディレクトリがない場合は作成する関数
# $1: 対象ディレクトリ
function set_dir () {
  local DIR=$1

  if [[ ! -d ${HOME}/${DIR} ]]; then
    mkdir -p ${HOME}/${DIR}
  fi
  return 0
}

# Claude Skillsのシンボリックリンクを設定する関数
function claude_skills_setting () {
  # ホームディレクトリ直下に.claude/skillsディレクトリが存在しない場合は作成
  set_dir ".claude/skills"

  SKILLS_DIR=("${DOTPATH}/.claude/skills/*")

  for skill_dir in ${SKILLS_DIR[@]}
  do
    rel_path="${skill_dir#${DOTPATH}/}"   # 先頭の ${DOTPATH}/ を取り除く
    if [[ ! -L ${HOME}/${rel_path} ]]; then
      # シンボリックリンクが存在しないときのみ作成
      echo "${DOTPATH}/${rel_path} ${HOME}/${rel_path}"
      create_ln ${rel_path}
    fi
  done
}

# Claude Contextのシンボリックリンクを設定する関数
function claude_context_setting () {
  local source_dir="${DOTPATH}/.claude/context"
  local target_dir="${HOME}/.claude/context"

  if [[ -d "$source_dir" ]]; then
    if [[ -L "$target_dir" ]]; then
      echo "context already linked: $target_dir"
    elif [[ -d "$target_dir" ]]; then
      echo "Warning: $target_dir exists as directory, skipping"
    else
      ln -sf "$source_dir" "$target_dir"
      echo "Linked: $source_dir -> $target_dir"
    fi
  fi
}

# Claude CLAUDE.mdのシンボリックリンクを設定する関数
function claude_md_setting () {
  local source_file="${DOTPATH}/.claude/CLAUDE.md"
  local target_file="${HOME}/.claude/CLAUDE.md"

  if [[ -f "$source_file" ]]; then
    if [[ -L "$target_file" ]]; then
      echo "CLAUDE.md already linked: $target_file"
    elif [[ -f "$target_file" ]]; then
      # 既存ファイルをバックアップしてからリンク
      mv "$target_file" "${target_file}.bak"
      ln -sf "$source_file" "$target_file"
      echo "Linked: $source_file -> $target_file (backup: ${target_file}.bak)"
    else
      ln -sf "$source_file" "$target_file"
      echo "Linked: $source_file -> $target_file"
    fi
  fi
}

# main関数実行
main


exit 0
